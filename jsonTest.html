<html>
<head>
   <link type="text/css" rel="stylesheet" href="jsonTest.css">

   <script src="build/sigma.min.js"></script>
<!--<script src="build/plugins/sigma.parsers.json.min.js"></script>-->
  
   <script type="text/javascript" src="heap.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
   <script type="text/javascript" src="build/plugins/sigma.parsers.gexf.min.js"></script>
   <script type="text/javascript" src="stringSet.js"></script>

    <link href="https://fonts.googleapis.com/css?family=PT+Sans|Zilla+Slab+Highlight" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Zilla+Slab" rel="stylesheet">
   
</head>
<body>
      <p id="instructText">Paste your JSON in the text area below and hit submit to see your gateways and services laid out automatically.</p>
   <div id="tutorial">

   
      <p>Examples of JSON that works include:</p>
      <pre>
      {"gateways": [{"id": "main","type": "main", "nodes": []}]} <br>
      </pre>
      <p>
         The structure of the JSON file begins like this. </p><pre>{"gateways": []} </pre><br>
      
     <p> To add a gateway or service, we add to the array a JSON object with the following structure. <br></p>
      
      <pre>
      
      {"id": "NAME", "type": "TYPEOFSERVICE", "nodes": []} <br>
      </pre>
   
      <p>
      An example of a well-formed JSON file would be the following. <br>
      
      
   </p>
   </div>
  
    <textarea type="textbox" id='jsonText' >{"gateways": [{"id": "main","type": "main", "nodes": ["html"]}, {"id":"activemq", "type": "activemq", "nodes": ["main", "html"]}, {"id": "service", "type": "service", "nodes":[]}, {"id": "html", "type": "html", "nodes": ["service"]}]}</textarea>
   <input type="button" value="submit" id="submit" onclick="uponClick()"></input>
   <script>
      function uponClick() {
      var jsonValue = JSON.parse(document.getElementById("jsonText").value);
      drawgraph(s, jsonValue);
      }
  </script>

    <div id="container"> <h1>Config File JSON to Graph</h1></div> 

   
<script>

   var s = new sigma('container');
   s.settings('zoomingRatio', 1);
   


   function drawgraph(s, jsonObj) {
   
      s.graph.clear();
      var seenArray = {};
      var seenStrings = new StringSet();
  
   var weights = {activemq: 1, main:2, html:3, postmsg:4, service:5};

   
   var heap = new Heap(function cmp(a, b) {
     if (a.weight < b.weight) {
       return -1;
     } 
     if (a.weight > b.weight) {
       return 1;
     }
     return 0;
   });
 

   var x = 0;
   var y = 0;
 
   var topNodeFlag = true;
   var topNode = "";
   var edge = 0;
      
   for (i = 0; i < jsonObj.gateways.length; i++) {
      var tempNode = jsonObj.gateways[i];
      tempNode.label = tempNode.id;
      tempNode.size = 3;
      tempNode.weight = weights[String(tempNode.type)];
      heap.push(tempNode);

      }
   
   for (i = 0; i < jsonObj.gateways.length; i++) {
      var tempNode = heap.pop();
      if (topNodeFlag) {
         topNode = tempNode;
         topNodeFlag = false;
         seenStrings.add(topNode.id);
      }
      tempNode.x = Math.random(0, 0.2);
      tempNode.y = y + 0.2;
      x = x + 0.2;
      y = y + 0.2;
      s.graph.addNode(tempNode);
      seenArray[tempNode.id] = tempNode;
      
   }
   
   for (i = 0; i < jsonObj.gateways.length; i++) {
      var tempNode = jsonObj.gateways[i];
      if (tempNode.nodes != {}) {
         for (j = 0; j < tempNode.nodes.length; j++) {
         s.graph.addEdge({id:edge.toString(), target: tempNode.nodes[j], source: tempNode.id});
         edge++;
          }
      } 
   }
      
   checkCycles(topNode, seenStrings);
   s.refresh();
   }
   
   
   function checkCycles(node, seenStrings) {
     alert(seenStrings);
         for (var index in node.nodes) {
            var childNode = node.nodes[index];
            alert(childNode);
            if (seenStrings.contains(childNode)) {
               alert("Looks like you have a cycle within your graph! It is " + childNode + ". Please fix the cycle and then graph again." );
               return true;
            } 
            seenStrings.add(childNode);
            checkCycles(seenArray[childNode]);
            
         }
         
      
      alert("Looks like you have no cycles in your graph and you're good to go.");
      return false;
      
   }
               
</script>
 
</body>
</html>